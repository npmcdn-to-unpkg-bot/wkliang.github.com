<!DOCTYPE html>
<!--
pg#678, Example 22-4. A Twitter search gadget, controlled by postMessage()

This is a Twitter search gadget. Include it in any webpage, inside an
iframe, and ask it to search for things by sending it a query string with
postMessage(). Since it is in an <iframe> and not a <script>, it can't
mess around with the containing document.
-->
<html>
<head>
<style> body {font: 9pt sans-serif; } </style>
<!-- Use jQuery for its jQuery.getJSON() utility -->
<script src="http://code.jquery.com/jquery-1.4.4.min.js"></script>
<script>
// We ought to just be able to use window.onmessage, but some older browser
// (e.q., Firefox 3) don't support it, so we do it this way instead.
if (window.addEventListener)
    window.addEventListener("message", handleMessage, false);
else
    window.attachEvent("onmessage", handleMessage);	// For IE8

function log(msg) {
    // window.parent.postMessage(msg, "*");
    console.log(msg);
}

function handleMessage(e) {
    // We don't care what the origin of this message is: we're willing
    // to search Twitter for anyone who asks us. We do expect the message
    // to come from the window that contains us, however.

    var searchterm = e.data;	// This is what were asked to search for
    log("rxfm: " + e.origin);

    if (e.source !== window.parent) return;

    // Use jQuery Ajax utilities and the Twitter search APO to find
    // tweets matching the message.
    jQuery.getJSON("http://search.twitter.com/search.json?callback=?",
	{ q: searchterm },
	function(data) {	// Called with request results
	    var tweets = data.results;
	    // Build an HTML document to display these results
	    var escaped = searchterm.replace("<", "&lt;");
	    var html = "<h2>" + escaped + "</h2>";
	    if (tweets.length == 0) {
		html += "No tweets found";
	    }
	    else {
		html += "<dl>";	// <dl> list of results
		for (var i = 0; i < tweets.length; i++) {
		    var tweet = tweets[i];
		    var text = tweet.text;
		    var from = tweet.from_user;
		    var tweeturl = "http://twitter.com/#!/" +
			from + "/status/" + tweet.id_str;
		    html += "<dt><a target='_blank' href='" +
			tweeturl + "'>" + tweet.from_user +
			"</a></dt><dd>" + tweet.text + "</dd>";
		}
		html += "</dl>";
	    }
	    // Set the <iframe> document
	    document.body.innerHTML = html;
	});
}

$(function() {
    // Let our container know we're here and ready to search.
    // The container can't
    window.parent.postMessage("Twitter Search v0.1", "*");
    log("Hello, world!");
});

</script>
</head>
<body>
<h1>Hello, World!</h1>
Twitter Search v0.1
</body>
</html>
